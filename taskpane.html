<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>My Task Pane</title>
  <!-- Load office.js and xlwings.min.js -->
  <script type="text/javascript" src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <!-- Bootstrap with the xlwings theme -->
  <link rel="stylesheet"
    href="https://cdn.jsdelivr.net/gh/xlwings/bootstrap-xlwings@5.2.3-2/dist/bootstrap-xlwings.min.css"
    integrity="sha384-TZ8CaOSXLBEEL73Aw1vX6a/2YP7QHdiuilF2C8Put8X81F3FzyRgt9ba77CMKAXq" crossorigin="anonymous">
  <!-- Load Custom Functions -->
</head>

<body>
    <!-- Put a button on the task pane -->
    <p>Hit the Run button 20:57!</p>
    <button id="run-btn" type="button">Run</button>
    <p>Hit the Run button to call the GET API !</p>
    <button id="run-btna" type="button">WS</button>
    <p>Hit the Run button to Say Hello !!</p>
    <button id="run-btnaH" type="button">Say Hello</button>

   <p>Hit the Run button to get time</p>
    <button id="run-btnaTime" type="button">Get Time </button>
  
    <script>
        // Initialize Office.js
        Office.onReady(function (info) { });

        // Add a click event listener to the button
        document.getElementById("run-btn").addEventListener("click", run);
        document.getElementById("run-btna").addEventListener("click", runws);
        document.getElementById("run-btnaH").addEventListener("click", runwspost);
        document.getElementById("run-btnaTime").addEventListener("click", runwspostActiveCell);
      

       // Based on 'Basic API call' sample from ScriptLab
async function runwspost() {
  await Excel.run(async (context) => {
    let activeCell = context.workbook.getActiveCell();
    activeCell.load("address, values,columnIndex,rowIndex");
    await context.sync();

    console.log("The active cell is " + activeCell.columnIndex + activeCell.rowIndex);
    const sheets = context.workbook.worksheets;
    let cell = sheets.getItem("Sheet1").getCell(activeCell.rowIndex,activeCell.columnIndex );
    cell.load("address, values");
    await context.sync();
    var jsonDate = cell.values[0][0];
    console.error(jsonDate);
    var text = " ";
    await new Promise(function (resolve, reject) {
      const url = "https://2e41-35-196-4-215.ngrok-free.app";
      var response = "";
      let xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (xhttp.readyState !== 4) return;

        if (xhttp.status == 200) {
          resolve(JSON.parse(xhttp.responseText).watchers_count);
          response = xhttp.responseText;
          text = xhttp.responseText;
          console.error("MAIN " + response);
          return response;

        } else {
          reject({
            status: xhttp.status,

            statusText: xhttp.statusText
          });
        }
      };

      xhttp.open("POST", url, true);
      xhttp.setRequestHeader("ngrok-skip-browser-warning", "1");
      xhttp.setRequestHeader('Content-Type', 'application/json');
      console.error("before va" + jsonDate);
      xhttp.send(JSON.stringify(jsonDate));

    });;

    console.error(text);
    console.error("after call");
    await context.sync();


    sheets.getItem("Sheet1").getCell(activeCell.rowIndex, activeCell.columnIndex+1).values  = [[ text]];
    await context.sync();
  });
}
      

      

async function runwspostActiveCell() {
  await Excel.run(async (context) => {
    let activeCell = context.workbook.getActiveCell();
    activeCell.load("address, values,columnIndex,rowIndex");
    await context.sync();

    console.log("The active cell is " + activeCell.columnIndex + activeCell.rowIndex );

  
    const sheets = context.workbook.worksheets;
    let cell = sheets.getItem("Sheet1").getCell(activeCell.columnIndex, activeCell.rowIndex);
    cell.load("address, values");

    await context.sync();
    var jsonDate = cell.values[0][0];
    console.error(jsonDate);
    var text = " ";
    await new Promise(function (resolve, reject) {
      const url = "https://6143-35-199-156-247.ngrok-free.app";
      var response = "";
      let xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (xhttp.readyState !== 4) return;

        if (xhttp.status == 200) {
          resolve(JSON.parse(xhttp.responseText).watchers_count);
          response = xhttp.responseText;
          text = xhttp.responseText;
          console.error("MAIN " + response);
          return response;

        } else {
          reject({
            status: xhttp.status,

            statusText: xhttp.statusText
          });
        }
      };

      xhttp.open("POST", url, true);
      xhttp.setRequestHeader("ngrok-skip-browser-warning", "1");
      xhttp.setRequestHeader('Content-Type', 'application/json');
      console.error("before va" + jsonDate);
      xhttp.send(JSON.stringify(jsonDate));

    });;

    console.error(text);
    console.error("after call");
    await context.sync();


    sheets.getItem("Sheet1").getCell(activeCell.rowIndex, activeCell.columnIndex).values = [[ text]];
    await context.sync();
  });
}
   
       
      
        async function run() {
            await Excel.run(async (context) => {
                const range = context.workbook.getSelectedRange();
                range.format.fill.color = "yellow";
                range.load("address");

                await context.sync();

                const sheets = context.workbook.worksheets;
                sheets.getItem("Sheet1").getRange("A1").values = [["The selected address was " + range.address + "."]];
            });
        }

      async function runws() {
            await Excel.run(async (context) => {
                const range = context.workbook.getSelectedRange();
                range.format.fill.color = "yellow";
                range.load("address");

                await context.sync();

                const sheets = context.workbook.worksheets;
                sheets.getItem("Sheet1").getRange("A1").values = [["The selected address was " + range.address + "."]];
            });
        }
    
async function runws() {
  await Excel.run(async (context) => {

    const range = context.workbook.getSelectedRange();
    range.format.fill.color = "yellow";
    range.load("address");
    console.error("Before call");
    var text = " ";
    await new Promise(function (resolve, reject) {
      const url = "https://160f-34-125-91-46.ngrok-free.app/";
      var response = "";
      let xhttp = new XMLHttpRequest();
      xhttp.onreadystatechange = function () {
        if (xhttp.readyState !== 4) return;

        if (xhttp.status == 200) {
          resolve(JSON.parse(xhttp.responseText).watchers_count);
          response = xhttp.responseText;
          text = xhttp.responseText;
          console.error("MAIN " + response);
          return response;

        } else {
          reject({
            status: xhttp.status,

            statusText: xhttp.statusText
          });
        }
      };

      xhttp.open("GET", url, true);
      xhttp.setRequestHeader("ngrok-skip-browser-warning", "1");

      xhttp.send();

    });;

    console.error(text);
    console.error("after call");
    await context.sync();

    const sheets = context.workbook.worksheets;
    sheets.getItem("Sheet1").getRange("A1").values = [["The selected address was " + text]];
    await context.sync();
  });
}


       

    </script>

     

</body>

</html>
